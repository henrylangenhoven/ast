name: üöÄ cPanel Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üöö Checkout Latest Code
        uses: actions/checkout@v4.2.2

      - name: üöÄ Deploy to cPanel
        id: deploy
        uses: paxha/cpanel-deploy@v4.0
        with:
          host: 'https://agroskytech.co.za'
          username: '${{ secrets.CPANEL_USERNAME }}'
          api_token: '${{ secrets.CPANEL_TOKEN }}'
          remote_path: '/home/agroskyt/repositories/ast'
          branch: main
          deploy: true

      - name: üöÄ Create GitHub Deployment
        id: create_deployment
        uses: octokit/request-action@v2.4.0
        with:
          route: POST /repos/:owner/:repo/deployments
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}
          ref: ${{ github.sha }}
          required_contexts: []
          environment: production
          auto_merge: false
          description: "Deploying to cPanel"
          payload: '{"url": "https://agroskytech.co.za"}'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚úÖ Mark Deployment as Successful
        if: success()
        uses: octokit/request-action@v2.4.0
        with:
          route: POST /repos/:owner/:repo/deployments/:deployment_id/statuses
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}
          deployment_id: ${{ steps.create_deployment.outputs.id }}
          state: success
          environment_url: "https://agroskytech.co.za"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚ùå Mark Deployment as Failed (if needed)
        if: failure()
        uses: octokit/request-action@v2.4.0
        with:
          route: POST /repos/:owner/:repo/deployments/:deployment_id/statuses
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}
          deployment_id: ${{ steps.create_deployment.outputs.id }}
          state: failure
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
